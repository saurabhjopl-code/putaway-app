<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scanner - Putaway App</title>
  <link rel="stylesheet" href="style.css">
  <script src="app.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="app-header">
    <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
    <div class="app-header-title">
      <span>RAJNANDINI FASHION LIMITED INDIA</span>
      <span>Warehouse Putaway System – Scanner</span>
    </div>
  </div>

  <p><a href="index.html">&larr; Back</a></p>

  <div class="card">
    <h2>Current Task</h2>
    <p>Task Code: <strong id="taskCodeLabel">[Not generated yet]</strong></p>
    <p><small>Task is auto-created on backend when you save first line. Task code is generated when you finish.</small></p>
    <p>
      Lines in this task: <span id="taskLineCount">0</span> |
      Units in this task: <span id="taskUnitCount">0</span>
    </p>
  </div>

  <div class="card">
    <h2>Scan & Store</h2>
    <div id="statusMessage" class="status"></div>

    <label for="binInput">Bin ID (scan or type)</label>
    <input type="text" id="binInput" autocomplete="off">

    <label for="skuInput">SKU ID (scan or type)</label>
    <input type="text" id="skuInput" autocomplete="off">
    <div id="skuNameHint"><small>SKU: -</small></div>

    <label for="qtyInput">Quantity</label>
    <input type="number" id="qtyInput" min="1" inputmode="numeric">

    <button id="saveLineBtn" class="primary">Save Line</button>
    <button id="finishTaskBtn" class="accent">Finish Task</button>
  </div>

  <div class="card">
    <h2>Camera Scanner</h2>
    <p>
      <button id="scanBinBtn" class="secondary">Scan Bin with Camera</button>
      <button id="scanSkuBtn" class="secondary">Scan SKU with Camera</button>
    </p>
    <div id="qrReader" style="width: 100%; max-width: 400px;"></div>
    <p><small>Allow camera permission when prompted.</small></p>
  </div>

  <script>
    let deviceId;
    let currentTaskId = null;

    let html5QrCode = null;
    let currentScanTarget = null; // 'bin' or 'sku'

    function showStatus(msg, isError = false) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = msg;
      statusEl.classList.remove('error', 'success');
      if (isError) {
        statusEl.classList.add('error');
      } else {
        statusEl.classList.add('success');
      }
    }

    function updateSkuHint(skuId) {
      const el = document.getElementById('skuNameHint');
      if (!el) return;
      if (!skuId) {
        el.innerHTML = '<small>SKU: -</small>';
        return;
      }
      const info = skuMap[skuId];
      if (info) {
        el.innerHTML = `<small>SKU: ${skuId} – ${info.name}</small>`;
      } else {
        el.innerHTML = `<small>SKU: ${skuId} (not in SKU master)</small>`;
      }
    }

    function refreshTaskSummary() {
      if (!currentTaskId) {
        document.getElementById('taskCodeLabel').textContent = '[Not generated yet]';
        document.getElementById('taskLineCount').textContent = '0';
        document.getElementById('taskUnitCount').textContent = '0';
        return;
      }
      const task = appData.tasks.find(t => t.id === currentTaskId);
      const lines = getLinesForTask(currentTaskId);
      const totalUnits = lines.reduce((sum, l) => sum + (parseInt(l.qty, 10) || 0), 0);

      document.getElementById('taskCodeLabel').textContent =
        task && task.code ? task.code : '[Not generated yet]';
      document.getElementById('taskLineCount').textContent = lines.length;
      document.getElementById('taskUnitCount').textContent = totalUnits;
    }

    async function initScanner() {
      const statusEl = document.getElementById('statusMessage');
      try {
        statusEl.textContent = 'Loading bins & SKUs...';
        await loadBins();
        await loadSkuMaster();

        deviceId = getDeviceId();

        statusEl.textContent = 'Loading data from backend...';
        await fetchAppData();

        // find existing IN_PROGRESS task for this device (if any)
        const existing = appData.tasks.find(
          t => t.status === 'IN_PROGRESS' && t.scannerDeviceId === deviceId
        );
        if (existing) {
          currentTaskId = existing.id;
        } else {
          currentTaskId = null; // will be set after first line is saved
        }

        refreshTaskSummary();
        showStatus('Ready. Scan Bin.', false);
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Error: ' + e.message;
        statusEl.classList.add('error');
        return;
      }

      const binInput = document.getElementById('binInput');
      const skuInput = document.getElementById('skuInput');
      const qtyInput = document.getElementById('qtyInput');
      const saveLineBtn = document.getElementById('saveLineBtn');
      const finishTaskBtn = document.getElementById('finishTaskBtn');
      const scanBinBtn = document.getElementById('scanBinBtn');
      const scanSkuBtn = document.getElementById('scanSkuBtn');

      binInput.focus();

      saveLineBtn.addEventListener('click', onSaveLine);
      finishTaskBtn.addEventListener('click', onFinishTask);

      binInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') skuInput.focus();
      });
      skuInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') qtyInput.focus();
      });
      qtyInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') onSaveLine();
      });

      skuInput.addEventListener('input', () => {
        updateSkuHint(skuInput.value.trim());
      });

      scanBinBtn.addEventListener('click', () => startScanner('bin'));
      scanSkuBtn.addEventListener('click', () => startScanner('sku'));
    }

    async function onSaveLine() {
      const binInput = document.getElementById('binInput');
      const skuInput = document.getElementById('skuInput');
      const qtyInput = document.getElementById('qtyInput');

      const binId = binInput.value.trim();
      const skuId = skuInput.value.trim();
      const qtyVal = parseInt(qtyInput.value, 10);

      if (!binId) {
        showStatus('Bin ID is required.', true);
        binInput.focus();
        return;
      }
      if (!binsMap[binId]) {
        showStatus('Invalid Bin ID: ' + binId, true);
        binInput.focus();
        return;
      }
      if (!skuId) {
        showStatus('SKU ID is required.', true);
        skuInput.focus();
        return;
      }
      if (!qtyVal || qtyVal <= 0) {
        showStatus('Quantity must be greater than 0.', true);
        qtyInput.focus();
        return;
      }

      try {
        // refresh data to get up-to-date usage before capacity check
        await fetchAppData();
        const used = getBinUsedUnits(binId);
        const capacity = binsMap[binId];
        if (used + qtyVal > capacity) {
          const free = capacity - used;
          showStatus(
            `Bin ${binId} capacity exceeded. Used=${used}, capacity=${capacity}, free=${free >= 0 ? free : 0}.`,
            true
          );
          return;
        }

        const resp = await saveLineToBackend(deviceId, binId, skuId, qtyVal);
        if (!resp.success) {
          showStatus('Failed to save line on server.', true);
          return;
        }
        currentTaskId = resp.taskId;

        await fetchAppData();
        refreshTaskSummary();
        showStatus(`Saved: Bin ${binId}, SKU ${skuId}, Qty ${qtyVal}`, false);

        skuInput.value = '';
        qtyInput.value = '';
        updateSkuHint('');
        skuInput.focus();
      } catch (e) {
        console.error(e);
        showStatus('Error: ' + e.message, true);
      }
    }

    async function onFinishTask() {
      if (!currentTaskId) {
        showStatus('No active task to finish.', true);
        return;
      }
      try {
        await fetchAppData();
        const lines = getLinesForTask(currentTaskId);
        if (lines.length === 0) {
          showStatus('Cannot finish an empty task. Add at least one line.', true);
          return;
        }

        const resp = await updateTaskStatusOnBackend(currentTaskId, 'OPEN', null);
        if (!resp.success) {
          showStatus('Failed to update task status on server.', true);
          return;
        }

        const taskCode = resp.code || '[code generated]';
        showStatus('Task submitted. Task ID: ' + taskCode, false);

        // After finishing, clear currentTaskId. Next save will create/use new IN_PROGRESS task.
        currentTaskId = null;
        await fetchAppData();
        refreshTaskSummary();
      } catch (e) {
        console.error(e);
        showStatus('Error: ' + e.message, true);
      }
    }

    // ===== CAMERA BARCODE SCANNING =====

    function startScanner(target) {
      currentScanTarget = target;
      const qrDivId = "qrReader";

      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode(qrDivId);
      }

      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          showStatus("No camera found", true);
          return;
        }
        const cameraId = devices[0].id;
        html5QrCode
          .start(
            cameraId,
            { fps: 10, qrbox: 250 },
            decodedText => {
              if (currentScanTarget === 'bin') {
                document.getElementById('binInput').value = decodedText.trim();
                document.getElementById('skuInput').focus();
              } else if (currentScanTarget === 'sku') {
                document.getElementById('skuInput').value = decodedText.trim();
                updateSkuHint(decodedText.trim());
                document.getElementById('qtyInput').focus();
              }
              stopScanner();
            },
            errorMessage => {
              // ignore per-frame errors
            }
          )
          .catch(err => {
            console.error(err);
            showStatus("Error starting camera: " + err, true);
          });
      }).catch(err => {
        console.error(err);
        showStatus("Unable to access camera: " + err, true);
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(err => console.error('Stop error', err));
      }
      currentScanTarget = null;
    }

    window.addEventListener('load', initScanner);
  </script>
</body>
</html>
